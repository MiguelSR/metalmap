<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/3.15/themes/css/cartodb.css" />
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" />
        <script src="http://libs.cartocdn.com/cartodb.js/v3/3.15/cartodb.js"></script>
        <style>
            html {height:100%;}
            body {background-color: black; height:100%;}
            #map {width:100%; height:100%;}
            #country-name {padding:0px 0px 5px 15px;}
            #list-loader {margin:0 auto;}
            #mylist {color: white; list-style-position: inside;}
            #mylist li {padding:0; margin:0 0 2px -30px;}
            #mylist li:hover { background-color: #333333;}
            #mylist li.style-selected { background-color: #333333;}
            .no-max-height {max-height: none !important; overflow-y:auto;}
            #bands-list {color: #AAA;}
        </style>
    </head>
    <body>
        <div id="map"></div>
        <div id="aux" style="color:white"></div>
        <script type="infowindow/html" id="infowindow_template">
            <div class="cartodb-popup dark v2">
                <a href="#close" class="cartodb-popup-close-button close">x</a>
                <div class="cartodb-popup-content-wrapper row">
                    <div class="cartodb-popup-content col-md-6 no-max-height">
                        <h3 id="country-name"></h3>
                        <ol id="mylist"></ol>
                    </div>
                    <div class="col-md-6">
                        <ul id="bands-list"><li>Loading...</li></ul>
                    </div> 
                </div>
                <div class="cartodb-popup-tip-container"></div>
            </div>
        </script>
        <script>
            "use strict";
            window.onload = function() {
                const API_ROOT = 'https://topillo.cartodb.com/api/v2';

                const renderStyles = function(data) {
                    if (data.rows.length) {
                        $('#country-name').html(data.rows[0].country);
                        $('#mylist').html('');

                        for (const styleRow of data.rows) {
                            renderStyleRow(styleRow);
                        }

                        $('#mylist li:first').addClass('style-selected');
                        renderBands(data.rows[0]);
                    }
                };
                const renderStyleRow = function(styleRow) {
                    const tpl = `<li id="${styleRow.cartodb_id}">${styleRow.style}: <strong>${styleRow.count}</strong></li>\n`; 

                    $('#mylist').append(tpl);
                    $('#' + styleRow.cartodb_id).click(
                        function checkStyle(event) {
                            $('.style-selected').removeClass('style-selected');
                            $(event.target).addClass('style-selected'); 
                            renderBands(styleRow);
                        }
                    );
                };
                const renderBands = function(styleRow) {
                    const bandsQuery = `${API_ROOT}/sql?q=select * from bands where country ilike '${styleRow.country}' and style like '${styleRow.style}' order by metalarchives_id asc limit 10`;
                    $.get(bandsQuery, function (bandsData) {
                        $('#bands-list').html(_.map(bandsData.rows, renderBandRow).join("\n"));
                    });
                };
                const renderBandRow = function(band) {
                    const bandLink = 'http://www.metal-archives.com/bands/' + band.name.replace(' ', '_') + '/' + band.metalarchives_id
                    return '<li><a href="'+bandLink+'" target="_blank">' + band.name + '</a></li>'
                };
                const getInfoWindowTemplate = function(country) {
                    const stylesQuery = `${API_ROOT}/sql?q=select * from grouped_bands where country like '${country.country}' order by count desc limit 10`
                    $.get(stylesQuery, renderStyles);
                    return $('#infowindow_template').html();
                }
                const initializeApp = function(vis, layers) {
                    const southWest = L.latLng(-90, -180);
                    const northEast = L.latLng(90, 180);

                    vis.map.set({
                        minZoom:3,
                        maxZoom:7
                    }); 

                    layers[0].leafletMap.setMaxBounds(L.latLngBounds(southWest, northEast))
                    layers[1].getSubLayer(0).infowindow.set('template', getInfoWindowTemplate);
                }

                cartodb.createVis('map', API_ROOT + '/viz/65949fe8-60b3-11e5-8c64-0e73ffd62169/viz.json', {
                        fullscreen: false,
                        legends: true,
                        search: false,
                        shareable: false
                    })
                    .done(initializeApp);

            }
        </script>
        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
             (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
             m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
             })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-68038867-1', 'auto');
            ga('send', 'pageview');
        </script>
    </body>
</html>
