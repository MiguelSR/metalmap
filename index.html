<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/3.15/themes/css/cartodb.css" />
        <script src="http://libs.cartocdn.com/cartodb.js/v3/3.15/cartodb.js"></script>
        <style>
            html {height:100%;}
            body {background-color: black; height:100%;}
            #map {width:100%; height:95%;}
            #mylist {color: white;}
            #mylist { list-style-position: inside;}
            #mylist li{  padding:0; margin:0 0 2px -30px;}
            #mylist li:hover{ background-color: #333333;}
            .no-max-height {max-height: none !important; overflow-y:auto;}
        </style>
    </head>
    <body>
        <div id="map"></div>
        <div id="aux" style="color:white"></div>
        <script type="infowindow/html" id="infowindow_template">
            <div class="cartodb-popup dark v2">
              <a href="#close" class="cartodb-popup-close-button close">x</a>
              <div class="cartodb-popup-content-wrapper">
                <div class="cartodb-popup-content no-max-height">
                    <h3 id="country-name"></h3>
                    <h4 id="list-loader"><i>Loading...</i></h4>
                    <ol id="mylist">
                    </ol>
                </div>
              </div>
              <div class="cartodb-popup-tip-container"></div>
            </div>
        </script>
        <script>
            "use strict";
            window.onload = function() {
                cartodb.createVis('map', 'https://topillo.cartodb.com/api/v2/viz/65949fe8-60b3-11e5-8c64-0e73ffd62169/viz.json', {
                        legends: true,
                    })
                    .done(function(vis, layers) {
                        const infoWindow = layers[1].getSubLayer(0).infowindow;
                        infoWindow.set('template', function(country) {
                            const query = "http://topillo.cartodb.com/api/v2/sql?q=select * from grouped_bands" +
                                          " where country like '"+ country.country +"' order by count desc limit 10";
                            $.get(query, function(data) {
                                if (data.rows.length) {
                                    $('#list-loader').hide();
                                    $('#country-name').html(country.country);
                                    $('#mylist').html('');

                                    for (const r of data.rows) {
                                        const tpl = '<li id="' + r.cartodb_id + '">'+ r.style +': <strong>' + r.count + '</strong></li>\n'; 
                                        $('#mylist').append(tpl);

                                        const query = "http://topillo.cartodb.com/api/v2/sql?q=select * from bands" +
                                                      " where country ilike '"+ country.country +"' and style like '" + r.style + "' order by metalarchives_id asc limit 10";
                                        $.get(query, function(data) {
                                            $('#' + r.cartodb_id).hover(
                                                function hoverIn() {
                                                   $('#aux').html(_.pluck(data.rows, 'name').join(" - ")); 
                                                }, function hoverOut() {
                                                   $('#aux').html('');
                                                }
                                            );
                                        });
                                    }
                                }
                            });
                            return $('#infowindow_template').html();
                        });

                        vis.map.set({
                            minZoom:2,
                            maxZoom:7
                        }); 
                    });
            }
        </script>
    </body>
</html>
